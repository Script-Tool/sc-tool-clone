<!DOCTYPE html>
<html lang="en">

<% include ../common/header%>
<style>
  .deleteTopicBtn{
    cursor: pointer;
    background-color: #e74a3b;
    right: 0px;
    width: 30px;
    color: white;
    align-items: center;
    font-weight: 900;
    display: flex;
    justify-content: center;
  }
</style>
<body id="page-top">

<!-- Page Wrapper -->
<div id="wrapper">

  <!-- Sidebar -->
  <% include ../common/customer-sidebar.ejs%>
  <!-- End of Sidebar -->

  <!-- Content Wrapper -->
  <div id="content-wrapper" class="d-flex flex-column">

    <!-- Main Content -->
    <div id="content">
      <!-- Begin Page Content -->
      <div class="container-fluid">
        <br/>
        <!-- Page Heading -->
        <div class="d-sm-flex align-items-center justify-content-between mb-4">
          <h1 class="h3 mb-0 text-gray-800">Keyword tool</h1>
          <div class="">
            <label>Khu vực</label>
            <select class="form-control" id="main_region">
              <option value="all">All</option>
              <option value="vn">Việt nam</option>
              <option value="us">US</option>
            </select>
          </div>
        </div>
      </div>
      <!-- /.container-fluid -->
      <div class="row ml-3 mb-2" style="overflow: scroll;">
        <button href="#" type="button" id="addTopicBtn" data-toggle="modal" data-target="#addTopic"
          class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm ml-2">
          Thêm chủ đề
        </button>
        <% topics.forEach(function(topic){ %>
          <div value="<%=topic.code%>" class="topic-item ml-2 mt-2 p-2 pr-4 bg-gradient-info text-white font-weight-bold border-left-warning" style="cursor: pointer">
            <%=topic.name%> (<%=topic.total_keywords%>)
          </div>
          <div class="deleteTopicBtn mt-2" value="<%=topic._id%>">X</div>
        <%})%>
      </div>

      <div class="filter d-flex align-items-end justify-content-between px-3">
        <div class="d-flex">
          <div class="form-group ml-2">
            <label for="exampleFormControlSelect1">Chủ đề</label>
            <select class="form-control" id="topic_code_filter">
              <option value="">All</option>
              <% topics.forEach(function(topic){ %>
                <div class="ml-2">
                  <option value="<%=topic.code%>"><%=topic.name%></option>
                </div>
              <%})%>
            </select>
          </div>
          <div class="form-group ml-2">
            <label for="exampleFormControlInput1" class="text-success"><%=count%> records</label>
            <button href="#" class="form-control" id="searchBtn" type="button" class="d-none d-sm-inline-block btn btn-sm btn-secondary shadow-sm"><i class="fas fa-remove fa-sm text-white-50"></i> 
              Search
            </button>
          </div>
          <div class="form-group ml-2">
            <label for="exampleFormControlInput1" class="text-success">|</label>
            <button href="#" type="button" data-toggle="modal" data-target="#addKeyword"
              class="d-none form-control d-sm-inline-block btn btn-sm btn-success shadow-sm">
              Thêm từ khóa
            </button>
          </div>
        </div>

        <nav aria-label="Page navigation example">
          <ul class="pagination">
            <li id="pre_page" class="page-item"><a class="page-link" href="#"><-</a></li>
            <li class="page-item"><a class="page-link" href="#"><%=current_page%></a></li>
            <li id="next_page" class="page-item"><a class="page-link" href="#">-></a></li>
          </ul>
        </nav>
      </div>
      <div class="table-responsive">
        <table class="table table-bordered" id="playlistTable" width="100%" cellspacing="0">
          <thead>
          <tr>
            <th>Keyword</th>
            <th>Khu vực</th>
            <th>Chủ đề</th>
            <th>Action</th>
          </tr>
          </thead>
          <tbody>
          <% keywords.forEach(function(keyword){ %>
          <tr>
            <td><%=keyword.keyword%></td>
            <td><%=keyword.region%></td>
            <td><%=keyword.topic_code%></td>
            <td>
              <a href="#" class="btn btn-danger a-btn-slide-text deleteBtn" value="<%=keyword._id%>"> Xóa </a>
            </td>
          </tr>
          <%})%>
          </tbody>
        </table>
      </div>
    </div>
    <!-- End of Main Content -->

    <div id="addTopic" class="modal" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Thêm chủ đề từ khóa</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label class="col-form-label">Tên</label>
              <input class="form-control" id="topic_name"/>
            </div>
            <div class="form-group">
              <label class="col-form-label">Danh mục cha</label>
              <select class="form-control" id="parent_topic_code">
                <option value="">None</option>
                <% topics.forEach(function(topic){ %>
                  <option value="<%=topic.code%>"><%=topic.name%></option>
                <%})%>
              </select>
            </div>
            <!-- <div class="form-group">
              <label class="col-form-label">Khu vực</label>
              <select class="form-control" id="topic_region">
                <option value="all">Tất cả</option>
                <option value="vn">Việt nam</option>
                <option value="us">US</option>
              </select>
            </div> -->
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              <button type="button" class="btn btn-primary" id="addTopicForm">Add</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="addKeyword" class="modal" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Thêm từ khóa</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div role="form">
              <div class="form-group">
                <label class="col-form-label">Keyword (Cách nhau dấu phẩy nếu thêm nhiều từ khóa)</label>
                <input class="form-control" id="keyword_form"/>
              </div>
              <div class="form-group">
                <label class="col-form-label">Chủ đề</label>
                <select class="form-control" id="topic_code_form">
                  <option value="">All</option>
                  <% topics.forEach(function(topic){ %>
                    <option value="<%=topic.code%>"><%=topic.name%></option>
                  <%})%>
                </select>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              <button type="button" class="btn btn-primary" id="addKeywordForm">Add</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <% include ../common/footer%>

  </div>
  <!-- End of Content Wrapper -->

</div>
<!-- End of Page Wrapper -->

<% include ../common/js%>
<script src="/js/bootbox.all.min.js"></script>
<script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
<script src="/javascripts/utils.js"></script>
<script>
  let per_page = 50
  let current_page = 1

  function getQuery() {
    let topic_code_filter = $('#topic_code_filter').val()

    let qr = `?per_page=${per_page}&current_page=${current_page}`
    if (topic_code_filter) {
      qr += `&topic_code_filter=${topic_code_filter}`
    }

    return qr
  }

  function getParameterByName(name, url = window.location.href) {
    name = name.replace(/[\[\]]/g, '\\$&');
    var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
      results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, ' '));
  }

  $(document).ready(function () {
    $('#topic_code_filter').val(getParameterByName('topic_code_filter'))

    per_page = Number(getParameterByName('per_page') || 20)
    current_page = Number(getParameterByName('current_page') || 1)
  });

  $('#profileFilter').on('change', function (e) {
    let filterVal = $('#profileFilter').val()
    console.log(filterVal)
    switch (filterVal) {
      case 'error':

        break;

      default:
        break;
    }
    let newPath = location.origin + location.pathname + '?filter=' + filterVal
    location.replace(newPath)
  })

  $('#pre_page').on('click', function (e) {
    if (current_page > 1) {
      current_page -= 1
      let newPath = location.origin + location.pathname + getQuery()
      location.replace(newPath)
    }
  })
  $('#next_page').on('click', function (e) {
    current_page += 1
    let newPath = location.origin + location.pathname + getQuery()
    location.replace(newPath)
  })

  $("#searchBtn").on('click', function (e) {
    let newPath = location.origin + location.pathname + getQuery()
    location.replace(newPath)
  });

  $(".topic-item").on('click', function (e) {
    let code = $(this).attr('value')
    if (code) {
      $('#topic_code_filter').val(code)
      let newPath = location.origin + location.pathname + getQuery()
      location.replace(newPath)
    }
  });

  $("#addTopicForm").on('click', function (e) {
    $.ajax({
      url: `/admin/customer/keyword-tool/add-topic`,
      type: "get",
      data: {
        name: $('#topic_name').val(),
        //region: $('#topic_region').val(),
        parent_topic_code: $('#parent_topic_code').val()
      },
    }).done(function (data) {
      if (data.success) {
        location.reload()
      }
    })
  });

  $("#addKeywordForm").on('click', function (e) {
    $.ajax({
      url: `/admin/customer/keyword-tool/add-keyword`,
      type: "get",
      data: {
        keyword: $('#keyword_form').val(),
        topic_code: $('#topic_code_form').val()
      },
    }).done(function (data) {
      if (data.success) {
        location.reload()
      }
    })
  });

  $("#addTopicBtn").on('click', function (e) {
    $('#topic_region').val($('#main_region').val())
  });
  
  $(".deleteTopicBtn").on('click', function (e) {
    console.log('dsfsdg');
    let id = $(this).attr('value')
    bootbox.confirm('Xóa chủ đề này ?', function (result) {
      if (result) {
        $.ajax({
          url: `/admin/customer/keyword-tool/delete-topic/${id}`,
          type: "get",
          contentType: 'application/json',
        }).done(function (data) {
          if (data.success) {
            location.reload()
          }
        })
      }
    })
  });

  $('#playlistTable').on('click', 'tr .deleteBtn', function () {
    let id = $(this).attr('value')
    
    bootbox.confirm('Xóa keyword này ?', function (result) {
      if (result) {
        $.ajax({
          url: `/admin/customer/keyword-tool/delete-keyword/${id}`,
          type: "get",
          contentType: 'application/json',
        }).done(function (data) {
          if (data.success) {
            location.reload()
          }
        })
      }
    })
  })
</script>

</body>

</html>